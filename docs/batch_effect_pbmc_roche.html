<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Almut Lütge" />


<title>Characterize batch effects</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/journal.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Characterize batch effects</h1>
<h4 class="author">Almut Lütge</h4>
<h4 class="date">19 April, 2020</h4>

</div>


<div id="pbmc_roche" class="section level2">
<h2>pbmc_roche</h2>
<p><a href="index.html">Back to home</a></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">suppressPackageStartupMessages</span>({
  <span class="kw">library</span>(CellBench)
  <span class="kw">library</span>(scater)
  <span class="kw">library</span>(CellMixS)
  <span class="kw">library</span>(variancePartition)
  <span class="kw">library</span>(purrr)
  <span class="kw">library</span>(jcolors)
  <span class="kw">library</span>(here)
  <span class="kw">library</span>(tidyr)
  <span class="kw">library</span>(dplyr)
  <span class="kw">library</span>(stringr)
  <span class="kw">library</span>(ComplexHeatmap)
  <span class="co">#library(ggtern)</span>
  <span class="kw">library</span>(gridExtra)
  <span class="kw">library</span>(scran)
  <span class="kw">library</span>(cowplot)
  <span class="kw">library</span>(CAMERA)
  <span class="kw">library</span>(ggrepel)
  <span class="kw">library</span>(readr)
})

<span class="kw">options</span>(<span class="dt">bitmapType=</span><span class="st">&#39;cairo&#39;</span>)</code></pre></div>
<div id="dataset-and-parameter" class="section level3">
<h3>Dataset and parameter</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sce &lt;-<span class="st"> </span><span class="kw">readRDS</span>(params$data)

param &lt;-<span class="st"> </span><span class="kw">readRDS</span>(params$param)
celltype &lt;-<span class="st"> </span>param[[<span class="st">&quot;celltype&quot;</span>]]
batch &lt;-<span class="st"> </span>param[[<span class="st">&quot;batch&quot;</span>]]
sample &lt;-<span class="st"> </span>param[[<span class="st">&quot;sample&quot;</span>]]
dataset_name &lt;-<span class="st"> </span>param[[<span class="st">&quot;dataset_name&quot;</span>]]
dataset_name</code></pre></div>
<pre><code>## [1] &quot;pbmc_roche&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n_genes &lt;-<span class="st"> </span><span class="kw">nrow</span>(sce)

<span class="kw">table</span>(<span class="kw">colData</span>(sce)[,celltype])</code></pre></div>
<pre><code>## 
##    0    1    2    3    4    5    6    7    8 
## 3243 2396 1197 1035  677  674  606  223   45</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">table</span>(<span class="kw">colData</span>(sce)[,batch])</code></pre></div>
<pre><code>## 
##  CS10  DMSO fresh   PSC 
##  2044  3095  3199  1758</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res_de &lt;-<span class="st"> </span><span class="kw">readRDS</span>(params$de)
abund &lt;-<span class="st"> </span><span class="kw">readRDS</span>(params$abund)
outputfile &lt;-<span class="st"> </span>params$out_file

cols &lt;-<span class="kw">c</span>(<span class="kw">c</span>(<span class="kw">jcolors</span>(<span class="st">&#39;pal6&#39;</span>),<span class="kw">jcolors</span>(<span class="st">&#39;pal8&#39;</span>))[<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">8</span>,<span class="dv">14</span>,<span class="dv">5</span>,<span class="dv">2</span>:<span class="dv">4</span>,<span class="dv">6</span>,<span class="dv">7</span>,<span class="dv">9</span>:<span class="dv">13</span>,<span class="dv">15</span>:<span class="dv">20</span>)],<span class="kw">jcolors</span>(<span class="st">&#39;pal4&#39;</span>))
<span class="kw">names</span>(cols) &lt;-<span class="st"> </span><span class="kw">c</span>()</code></pre></div>
</div>
<div id="visualize-data" class="section level3">
<h3>Visualize data</h3>
<p>How are sample, celltypes and batches distributed within normalized, but not batch corrected data?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">feature_list &lt;-<span class="st"> </span><span class="kw">c</span>(batch, celltype, sample)
feature_list &lt;-<span class="st"> </span>feature_list[<span class="kw">which</span>(!<span class="kw">is.na</span>(feature_list))]

<span class="kw">lapply</span>(feature_list, function(feature_name){
  <span class="kw">visGroup</span>(sce, feature_name, <span class="dt">dim_red=</span> <span class="st">&quot;UMAP&quot;</span>)
})</code></pre></div>
<pre><code>## [[1]]</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/vis-1.png" width="672" /></p>
<pre><code>## 
## [[2]]</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/vis-2.png" width="672" /></p>
<pre><code>## 
## [[3]]</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/vis-3.png" width="672" /></p>
</div>
</div>
<div id="batch-strengthsize" class="section level2">
<h2>Batch strength/size</h2>
<p>To compare or describe the severity of a batch effect there are different meassures. In general they can either give an estimate of the relative strength compared to the signal of interest e.g. the celltype signal or an absolut estimate e.g. the number of batch affected genes.</p>
<div id="variance-partitioning" class="section level3">
<h3>Variance partitioning</h3>
<p>How much of the variance within the datasets can we attributed to the batch effect and how much could be explained by the celltype? Which genes are mostly affected?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">vp_vars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;vp_batch&quot;</span>, <span class="st">&quot;vp_celltype&quot;</span>, <span class="st">&quot;vp_residuals&quot;</span>)
vp &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">rowData</span>(sce)[, vp_vars])  %&gt;%<span class="st"> </span>dplyr::<span class="kw">mutate</span>(<span class="dt">gene=</span> <span class="kw">rownames</span>(sce)) %&gt;%<span class="st"> </span>dplyr::<span class="kw">arrange</span>(-vp_batch)
vp_sub &lt;-<span class="st"> </span>vp[<span class="dv">1</span>:<span class="dv">3</span>] %&gt;%<span class="st"> </span><span class="kw">set_rownames</span>(vp$gene)</code></pre></div>
<pre><code>## Warning: Setting row names on a tibble is deprecated.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#plot</span>
<span class="kw">plotPercentBars</span>( vp_sub[<span class="dv">1</span>:<span class="dv">10</span>,] )</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/variance%20part-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotVarPart</span>( vp_sub )</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/variance%20part-2.png" width="672" /></p>
</div>
<div id="variance-and-gene-expression" class="section level3 tabset tabset-pills">
<h3>Variance and gene expression</h3>
<p>Are general expression and batch effect related? Does the batch effect or the celltype effect preferable manifest within highly, medium or low expressed genes?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#define expression classes by mean expression quantiles </span>
th &lt;-<span class="st"> </span><span class="kw">quantile</span>(<span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)$logcounts), <span class="kw">c</span>(.<span class="dv">33</span>, .<span class="dv">66</span>))
high_th &lt;-<span class="st"> </span>th[<span class="dv">2</span>]
mid_th &lt;-<span class="st"> </span>th[<span class="dv">1</span>]

<span class="kw">rowData</span>(sce)$expr_class &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)$logcounts) &gt;<span class="st"> </span>high_th, <span class="st">&quot;high&quot;</span>,
                                  <span class="kw">ifelse</span>(<span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)$logcounts) &lt;=<span class="st"> </span>high_th &amp;
<span class="st">                                           </span><span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)$logcounts) &gt;<span class="st"> </span>mid_th, 
                                         <span class="st">&quot;medium&quot;</span>, <span class="st">&quot;low&quot;</span>))
<span class="kw">rowData</span>(sce)$mean_expr &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(<span class="kw">assays</span>(sce)$logcounts)

<span class="co">#plot </span>
plot_dev &lt;-<span class="st"> </span>function(var, var_col){
  <span class="kw">ggplot</span>(<span class="kw">as.data.frame</span>(<span class="kw">rowData</span>(sce)), <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">&quot;mean_expr&quot;</span>, <span class="dt">y =</span> var, <span class="dt">colour =</span> var_col)) +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_point</span>() +<span class="st"> </span>
<span class="st">  </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>)
}

<span class="co">#Ternary plots</span>
<span class="co"># ggtern(data=as.data.frame(rowData(sce)),aes(vp_batch, vp_celltype, vp_residuals)) + </span>
<span class="co">#   stat_density_tern(aes(fill=..level.., alpha=..level..),geom=&#39;polygon&#39;) +</span>
<span class="co">#   scale_fill_gradient2(high = &quot;red&quot;) +</span>
<span class="co">#   guides(color = &quot;none&quot;, fill = &quot;none&quot;, alpha = &quot;none&quot;) +</span>
<span class="co">#   geom_point(size= 0.1, alpha = 0.5)  + </span>
<span class="co">#   Llab(&quot;batch&quot;) +</span>
<span class="co">#   Tlab(&quot;celltype&quot;) +</span>
<span class="co">#   Rlab(&quot;other&quot;) +</span>
<span class="co">#   theme_bw()</span>
<span class="co"># </span>
<span class="co"># t1 &lt;- ggtern(data=as.data.frame(rowData(sce)),aes(vp_batch, vp_celltype, vp_residuals)) + </span>
<span class="co">#   geom_point(size = 0.1) +</span>
<span class="co">#   geom_density_tern() + </span>
<span class="co">#   Llab(&quot;batch&quot;) +</span>
<span class="co">#   Tlab(&quot;celltype&quot;) +</span>
<span class="co">#   Rlab(&quot;other&quot;) +</span>
<span class="co">#   theme_bw()</span>

## Summarize variance partitioning
<span class="co"># How many genes have a variance component affected by batch with &gt; 1%</span>
n_batch_gene &lt;-<span class="st"> </span>vp_sub %&gt;%<span class="st"> </span>dplyr::<span class="kw">filter</span>(vp_batch &gt;<span class="st"> </span><span class="fl">0.01</span>) %&gt;%<span class="st"> </span><span class="kw">nrow</span>()/n_genes
n_batch_gene10 &lt;-<span class="st"> </span>vp_sub %&gt;%<span class="st"> </span>dplyr::<span class="kw">filter</span>(vp_batch &gt;<span class="st"> </span><span class="fl">0.1</span>) %&gt;%<span class="st"> </span><span class="kw">nrow</span>()/n_genes
n_celltype_gene &lt;-<span class="st"> </span>vp_sub %&gt;%<span class="st"> </span>dplyr::<span class="kw">filter</span>(vp_celltype&gt;<span class="st"> </span><span class="fl">0.01</span>) %&gt;%<span class="st"> </span><span class="kw">nrow</span>()/n_genes
n_rel &lt;-<span class="st"> </span>n_batch_gene/n_celltype_gene

<span class="co"># Mean variance that is explained by the batch effect/celltype</span>
m_batch &lt;-<span class="st"> </span><span class="kw">mean</span>(vp_sub$vp_batch, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
m_celltype &lt;-<span class="st"> </span><span class="kw">mean</span>(vp_sub$vp_celltype, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
m_rel &lt;-<span class="st"> </span>m_batch/m_celltype</code></pre></div>
<div id="scatterplot-batch" class="section level4">
<h4>Scatterplot batch</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_dev</span>(<span class="st">&quot;vp_batch&quot;</span>, <span class="st">&quot;vp_batch&quot;</span>)</code></pre></div>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/var_plot_batch-1.png" width="672" /></p>
</div>
<div id="scatterplot-celltype" class="section level4">
<h4>Scatterplot celltype</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot_dev</span>(<span class="st">&quot;vp_celltype&quot;</span>, <span class="st">&quot;vp_celltype&quot;</span>)</code></pre></div>
<pre><code>## `geom_smooth()` using formula &#39;y ~ x&#39;</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/var_plot_celltype-1.png" width="672" /></p>
</div>
<div id="ternary-plot-all-genes" class="section level4">
<h4>Ternary plot all genes</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#t1</span></code></pre></div>
</div>
<div id="ternary-plot-gene-expression-classes" class="section level4">
<h4>Ternary plot gene expression classes</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#t1 + facet_grid(~expr_class)</span></code></pre></div>
</div>
</div>
<div id="cellspecific-mixing-score" class="section level3 tabset tabset-pills">
<h3>Cellspecific Mixing score</h3>
<div id="overall" class="section level4">
<h4>Overall</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#visualize overall cms score</span>
<span class="kw">visHist</span>(sce, <span class="dt">n_col =</span> <span class="dv">2</span>, <span class="dt">prefix =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/cms-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">visMetric</span>(sce, <span class="dt">metric =</span> <span class="st">&quot;cms_smooth&quot;</span>, <span class="dt">dim_red =</span> <span class="st">&quot;UMAP&quot;</span>)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/cms-2.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">visGroup</span>(sce, celltype, <span class="dt">dim_red =</span> <span class="st">&quot;UMAP&quot;</span>)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/cms-3.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summarize</span>
mean_cms &lt;-<span class="st"> </span><span class="kw">mean</span>(sce$cms)
n_cms_0<span class="fl">.01</span> &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">which</span>(sce$cms &lt;<span class="st"> </span><span class="fl">0.01</span>))
cluster_mean_cms &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">colData</span>(sce)) %&gt;%<span class="st"> </span><span class="kw">group_by_at</span>(celltype) %&gt;%<span class="st"> </span><span class="kw">summarize</span>(<span class="dt">cms_mean =</span> <span class="kw">mean</span>(cms))
var_cms &lt;-<span class="st"> </span><span class="kw">var</span>(cluster_mean_cms$cms_mean)</code></pre></div>
</div>
<div id="celltypes-cms-smooth" class="section level4">
<h4>Celltypes cms smooth</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#compare by celltypes</span>
<span class="kw">visCluster</span>(sce, <span class="dt">metric_var =</span> <span class="st">&quot;cms_smooth&quot;</span>, <span class="dt">cluster_var =</span> celltype)</code></pre></div>
<pre><code>## Picking joint bandwidth of 0.0266</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/cms%20celltypes-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">visCluster</span>(sce, <span class="dt">metric_var =</span> <span class="st">&quot;cms_smooth&quot;</span>, <span class="dt">cluster_var =</span> celltype, <span class="dt">violin =</span> <span class="ot">TRUE</span>)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/cms%20celltypes-2.png" width="672" /></p>
</div>
<div id="celltypes-histogram" class="section level4">
<h4>Celltypes histogram</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#compare histogram by celltype</span>

p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">as.data.frame</span>(<span class="kw">colData</span>(sce)), 
            <span class="kw">aes_string</span>(<span class="dt">x =</span> <span class="st">&quot;cms&quot;</span>, <span class="dt">fill =</span> celltype)) +<span class="st"> </span>
<span class="st">                </span><span class="kw">geom_histogram</span>() +<span class="st"> </span>
<span class="st">                </span><span class="kw">facet_wrap</span>(celltype, <span class="dt">scales =</span> <span class="st">&quot;free_y&quot;</span>, <span class="dt">ncol =</span> <span class="dv">3</span>) +
<span class="st">                </span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> cols) +
<span class="st">                </span><span class="kw">theme_classic</span>()

p +<span class="st"> </span><span class="kw">geom_vline</span>(<span class="kw">aes_string</span>(<span class="dt">xintercept =</span> <span class="st">&quot;cms_mean&quot;</span>, 
                   <span class="dt">colour =</span> celltype), 
               cluster_mean_cms, <span class="dt">linetype=</span><span class="dv">2</span>) +<span class="st"> </span>
<span class="st">  </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> cols) </code></pre></div>
<pre><code>## `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/cms%20histogram-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="celltype-specificity" class="section level2">
<h2>Celltype specificity</h2>
<div id="celltype-abundance" class="section level3">
<h3>Celltype abundance</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">meta_tib &lt;-<span class="st"> </span><span class="kw">as_tibble</span>(<span class="kw">colData</span>(sce)) %&gt;%<span class="st"> </span><span class="kw">group_by_at</span>(<span class="kw">c</span>(batch, celltype)) %&gt;%<span class="st"> </span><span class="kw">summarize</span>(<span class="dt">n =</span> <span class="kw">n</span>()) %&gt;%<span class="st"> </span>dplyr::<span class="kw">mutate</span>(<span class="dt">cell_freq =</span> n /<span class="st"> </span><span class="kw">sum</span>(n))

plot_abundance &lt;-<span class="st"> </span>function(cluster_var, tib, x_var){
  meta_df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">eval</span>(tib))
  p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data=</span>meta_df, <span class="kw">aes_string</span>(<span class="dt">x=</span>x_var, <span class="dt">y=</span><span class="st">&quot;cell_freq&quot;</span>, <span class="dt">fill =</span> cluster_var)) +
<span class="st">    </span><span class="kw">geom_bar</span>(<span class="dt">stat=</span><span class="st">&quot;identity&quot;</span>) +<span class="st"> </span><span class="kw">scale_fill_manual</span>(<span class="dt">values=</span>cols, <span class="dt">name =</span> <span class="st">&quot;celltype&quot;</span>)
  p +<span class="st"> </span><span class="kw">coord_flip</span>() +<span class="st"> </span><span class="kw">theme_minimal</span>() 
}

<span class="kw">plot_abundance</span>(<span class="dt">cluster_var =</span> celltype, <span class="dt">tib =</span> meta_tib, <span class="dt">x_var =</span> batch)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/celltype%20abundance-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#summarize diff abundance</span>
mean_rel_abund_diff &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">unlist</span>(abund))
min_rel_abund_diff &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">unlist</span>(abund))
max_rel_abund_diff &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">unlist</span>(abund))</code></pre></div>
</div>
<div id="batch-and-celltype-specific-count-distributions" class="section level3">
<h3>Batch and celltype specific count distributions</h3>
<p>Do the overall count distribution vary between batches? Are count distributions celltype depended</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#batch level</span>
bids &lt;-<span class="st"> </span><span class="kw">levels</span>(<span class="kw">as.factor</span>(<span class="kw">colData</span>(sce)[, batch]))
<span class="kw">names</span>(bids) &lt;-<span class="st"> </span>bids
cids &lt;-<span class="st"> </span><span class="kw">levels</span>(<span class="kw">as.factor</span>(<span class="kw">colData</span>(sce)[, celltype]))
<span class="kw">names</span>(cids) &lt;-<span class="st"> </span>cids

<span class="co">#mean gene expression by batch and cluster</span>
mean_list &lt;-<span class="st"> </span><span class="kw">lapply</span>(bids, function(batch_var){
  mean_cluster &lt;-<span class="st"> </span><span class="kw">lapply</span>(cids, function(cluster_var){
    counts_sc &lt;-<span class="st"> </span><span class="kw">as.matrix</span>(<span class="kw">logcounts</span>(
      sce[, <span class="kw">colData</span>(sce)[, batch] %in%<span class="st"> </span>batch_var &amp;<span class="st"> </span>
<span class="st">            </span><span class="kw">colData</span>(sce)[, celltype] %in%<span class="st"> </span>cluster_var]))
  })
  mean_c &lt;-<span class="st"> </span>mean_cluster %&gt;%<span class="st"> </span><span class="kw">map</span>(rowMeans) %&gt;%<span class="st"> </span>bind_rows %&gt;%
<span class="st">    </span>dplyr::<span class="kw">mutate</span>(<span class="dt">gene=</span><span class="kw">rownames</span>(sce)) %&gt;%<span class="st"> </span>
<span class="st">    </span><span class="kw">gather</span>(cluster, logcounts, cids)
})</code></pre></div>
<pre><code>## Note: Using an external vector in selections is ambiguous.
## ℹ Use `all_of(cids)` instead of `cids` to silence this message.
## ℹ See &lt;https://tidyselect.r-lib.org/reference/faq-external-vector.html&gt;.
## This message is displayed once per session.</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">mean_expr &lt;-<span class="st"> </span>mean_list %&gt;%<span class="st"> </span><span class="kw">bind_rows</span>(<span class="dt">.id=</span> <span class="st">&quot;batch&quot;</span>)

<span class="kw">ggplot</span>(mean_expr, <span class="kw">aes</span>(<span class="dt">x=</span>logcounts, <span class="dt">colour=</span>batch)) +<span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">alpha=</span>.<span class="dv">3</span>) +
<span class="st">  </span><span class="kw">theme_classic</span>() +
<span class="st">  </span><span class="kw">facet_wrap</span>( ~<span class="st"> </span>cluster, <span class="dt">ncol =</span> <span class="dv">3</span>) +
<span class="st">  </span><span class="kw">scale_colour_manual</span>(<span class="dt">values =</span> cols) +
<span class="st">  </span><span class="kw">scale_x_continuous</span>(<span class="dt">limits =</span>  <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">7</span>))</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/count%20distributions-1.png" width="960" /></p>
</div>
<div id="batch-to-batch-comparisons-of-expression-distributions" class="section level3">
<h3>Batch to batch comparisons of expression distributions</h3>
</div>
</div>
<div id="differentially-expressed-genes" class="section level2">
<h2>Differentially expressed genes</h2>
<div id="upset-plot" class="section level3">
<h3>Upset plot</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Upset plot\
cont &lt;-<span class="st"> </span>param[[<span class="st">&quot;cont&quot;</span>]]
cs &lt;-<span class="st"> </span><span class="kw">names</span>(cont)
<span class="kw">names</span>(cs) &lt;-<span class="st"> </span>cs

<span class="co"># Filter DEG by pvalue</span>
FilterDEGs &lt;-<span class="st"> </span>function (<span class="dt">degDF =</span> df, <span class="dt">filter =</span> <span class="kw">c</span>(<span class="dt">FDR =</span> <span class="dv">5</span>)){
  <span class="kw">rownames</span>(degDF) &lt;-<span class="st"> </span>degDF$gene
  <span class="co">#pval &lt;- degDF[, grep(&quot;adj.P.Val$&quot;, colnames(degDF)), drop = FALSE]</span>
  pval &lt;-<span class="st"> </span>degDF[, <span class="kw">grep</span>(<span class="st">&quot;PValue$&quot;</span>, <span class="kw">colnames</span>(degDF)), drop =<span class="st"> </span><span class="ot">FALSE</span>]
  pf &lt;-<span class="st"> </span>pval &lt;=<span class="st"> </span>filter[<span class="st">&quot;FDR&quot;</span>]/<span class="dv">100</span>
  pf[<span class="kw">is.na</span>(pf)] &lt;-<span class="st"> </span><span class="ot">FALSE</span>
  DEGlistUPorDOWN &lt;-<span class="st"> </span><span class="kw">sapply</span>(<span class="kw">colnames</span>(pf), function(x) <span class="kw">rownames</span>(pf[pf[, x, <span class="dt">drop =</span> <span class="ot">FALSE</span>], , <span class="dt">drop =</span> <span class="ot">FALSE</span>]), <span class="dt">simplify =</span> <span class="ot">FALSE</span>)
}

result &lt;-<span class="st"> </span><span class="kw">list</span>()
m2 &lt;-<span class="st"> </span><span class="kw">list</span>()

for(jj in <span class="dv">1</span>:<span class="kw">length</span>(cs)){
  result[[jj]] &lt;-<span class="st"> </span><span class="kw">sapply</span>(res_de[[<span class="dv">1</span>]][[<span class="kw">names</span>(cs)[jj]]], function(x) <span class="kw">FilterDEGs</span>(x))
  <span class="kw">names</span>(result[[jj]]) &lt;-<span class="st"> </span>cids
  m2[[jj]] =<span class="st"> </span><span class="kw">make_comb_mat</span>(result[[jj]], <span class="dt">mode =</span> <span class="st">&quot;intersect&quot;</span>)
}

<span class="kw">names</span>(result) &lt;-<span class="st"> </span><span class="kw">names</span>(cs)
<span class="kw">names</span>(m2) &lt;-<span class="st"> </span><span class="kw">names</span>(cs)

<span class="kw">lapply</span>(m2, function(x) <span class="kw">UpSet</span>(x))</code></pre></div>
<pre><code>## $`fresh-DMSO`</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/de%20res-1.png" width="672" /></p>
<pre><code>## 
## $`fresh-PSC`</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/de%20res-2.png" width="672" /></p>
<pre><code>## 
## $`fresh-CS10`</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/de%20res-3.png" width="672" /></p>
</div>
<div id="logfold_change-and-gsea" class="section level3">
<h3>Logfold_change and GSEA</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># DE genes (per cluster and mean)</span>
res &lt;-<span class="st"> </span>res_de[[<span class="st">&quot;table&quot;</span>]]
<span class="co">#n_de &lt;- lapply(res, function(y) vapply(y, function(x) sum(x$adj.P.Val &lt; 0.05), numeric(1)))</span>
n_de &lt;-<span class="st"> </span><span class="kw">lapply</span>(res, function(y) <span class="kw">vapply</span>(y, function(x) <span class="kw">sum</span>(x$adj.PValue &lt;<span class="st"> </span><span class="fl">0.05</span>), <span class="kw">numeric</span>(<span class="dv">1</span>)))
n_genes_lfc1 &lt;-<span class="st"> </span><span class="kw">lapply</span>(res, function(y) <span class="kw">vapply</span>(y, function(x) <span class="kw">sum</span>(<span class="kw">abs</span>(x$logFC) &gt;<span class="st"> </span><span class="dv">1</span>), <span class="kw">numeric</span>(<span class="dv">1</span>)))
mean_n_genes_lfc1 &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">unlist</span>(n_genes_lfc1))/n_genes

<span class="co"># plot DE for all comparison and check gene sets</span>
<span class="co">#get geneset</span>
gs &lt;-<span class="st"> </span><span class="kw">read_delim</span>(params$gs, <span class="dt">delim =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">col_names =</span> <span class="st">&quot;cat&quot;</span>)</code></pre></div>
<pre><code>## Parsed with column specification:
## cols(
##   cat = col_character()
## )</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cats &lt;-<span class="st"> </span><span class="kw">sapply</span>(gs$cat, function(u) <span class="kw">strsplit</span>(u, <span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)[[<span class="dv">1</span>]][-<span class="dv">2</span>], 
               <span class="dt">USE.NAMES =</span> <span class="ot">FALSE</span>)
<span class="kw">names</span>(cats) &lt;-<span class="st"> </span><span class="kw">sapply</span>(cats, .subset, <span class="dv">1</span>)
cats &lt;-<span class="st"> </span><span class="kw">lapply</span>(cats, function(u) u[-<span class="dv">1</span>])

plotDE &lt;-<span class="st"> </span>function(cont_var){
  <span class="co">#res_s &lt;- res[[cont_var]] %&gt;% map(filter, adj.P.Val &lt; .05) %&gt;% map(filter, abs(logFC) &gt; 1)</span>
  res_s &lt;-<span class="st"> </span>res[[cont_var]] %&gt;%<span class="st"> </span><span class="kw">map</span>(dplyr::filter, PValue &lt;<span class="st"> </span>.<span class="dv">05</span>) %&gt;%<span class="st"> </span><span class="kw">map</span>(dplyr::filter, <span class="kw">abs</span>(logFC) &gt;<span class="st"> </span><span class="dv">1</span>)
  
  <span class="co">#plot</span>
  <span class="kw">lapply</span>(<span class="kw">names</span>(res[[cont_var]]), function(ct){
    ct_de &lt;-<span class="st"> </span>res[[cont_var]][[ct]]
    ct_de$gene &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&#39;[A-z0-9]*</span><span class="ch">\\</span><span class="st">.&#39;</span>, <span class="st">&#39;&#39;</span>, ct_de$gene)
    res_s[[ct]]$gene &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&#39;[A-z0-9]*</span><span class="ch">\\</span><span class="st">.&#39;</span>, <span class="st">&#39;&#39;</span>, res_s[[ct]]$gene)
    
    <span class="co">#p &lt;- ggplot(ct_de, aes(x = AveExpr, y = logFC, colour = abs(logFC) &gt; 1, label = gene)) + </span>
    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(ct_de, <span class="kw">aes</span>(<span class="dt">x =</span> logCPM, <span class="dt">y =</span> logFC, <span class="dt">colour =</span> <span class="kw">abs</span>(logFC) &gt;<span class="st"> </span><span class="dv">2</span>, <span class="dt">label =</span> gene)) +<span class="st"> </span>
<span class="st">      </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>, <span class="dt">alpha =</span> .<span class="dv">5</span>) +
<span class="st">      </span><span class="kw">geom_label_repel</span>(<span class="dt">data =</span> res_s[[ct]]) +
<span class="st">      </span><span class="kw">ggtitle</span>(<span class="kw">paste0</span>(ct,<span class="st">&quot;: &quot;</span>, cont_var)) +
<span class="st">      </span><span class="kw">theme_classic</span>()
    <span class="kw">print</span>(p)
    
    <span class="kw">cat</span>(<span class="st">&quot;Cluster:&quot;</span>, ct, <span class="st">&quot;Contrast:&quot;</span>, cont_var, 
        <span class="st">&quot;Num genes:&quot;</span>, <span class="kw">nrow</span>(ct_de), <span class="st">&quot;Num DE:&quot;</span>, <span class="kw">nrow</span>(res_s[[ct]]), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span> )

    <span class="co"># run &#39;camera&#39; for this comparison</span>
    inds &lt;-<span class="st"> </span><span class="kw">ids2indices</span>(cats, ct_de$gene)
    <span class="co">#cm &lt;- cameraPR(ct_de$t, inds) #LR</span>
    cm &lt;-<span class="st"> </span><span class="kw">cameraPR</span>(ct_de$F, inds)
    <span class="kw">print</span>(cm %&gt;%<span class="st"> </span><span class="kw">rownames_to_column</span>(<span class="st">&quot;category&quot;</span>) %&gt;%<span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(FDR &lt;<span class="st"> </span>.<span class="dv">05</span> &amp;<span class="st"> </span>NGenes &gt;=<span class="st"> </span><span class="dv">5</span>) %&gt;%<span class="st"> </span><span class="kw">head</span>(<span class="dv">8</span>))
  })
}

if( <span class="kw">length</span>(<span class="kw">names</span>(res)) &lt;=<span class="st"> </span><span class="dv">3</span> ){
    pathways &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">names</span>(res), plotDE)
}</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-1.png" width="672" /></p>
<pre><code>## Cluster: 0 Contrast: fresh-DMSO Num genes: 4756 Num DE: 0 
##                                             category NGenes Direction
## 1          GO_TRANSLATION_ELONGATION_FACTOR_ACTIVITY     13        Up
## 2                                 GO_ANTIGEN_BINDING     45        Up
## 3              GO_STRUCTURAL_CONSTITUENT_OF_RIBOSOME    153        Up
## 4                     GO_MHC_PROTEIN_COMPLEX_BINDING     15        Up
## 5 GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 6                    GO_EXTRACELLULAR_MATRIX_BINDING     11        Up
## 7                         GO_VIRUS_RECEPTOR_ACTIVITY     19        Up
## 8                GO_FIBROBLAST_GROWTH_FACTOR_BINDING      9        Up
##         PValue          FDR
## 1 4.684898e-10 3.968109e-07
## 2 2.154834e-08 9.125720e-06
## 3 5.474379e-07 1.159200e-04
## 4 7.562472e-07 1.281083e-04
## 5 3.033735e-06 4.282623e-04
## 6 3.616275e-05 4.164931e-03
## 7 4.046945e-05 4.164931e-03
## 8 4.425546e-05 4.164931e-03</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-2.png" width="672" /></p>
<pre><code>## Cluster: 1 Contrast: fresh-DMSO Num genes: 4756 Num DE: 4 
##                                                                                                          category
## 1                                                                                               GO_R_SMAD_BINDING
## 2                                                                                       GO_HMG_BOX_DOMAIN_BINDING
## 3                                                                              GO_MAP_KINASE_PHOSPHATASE_ACTIVITY
## 4                                                                                GO_CAMP_RESPONSE_ELEMENT_BINDING
## 5                                                                       GO_TRANSLATION_ELONGATION_FACTOR_ACTIVITY
## 6                                                                                                 GO_SMAD_BINDING
## 7 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 8                                                                                        GO_GROWTH_FACTOR_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 2.170195e-21 1.838155e-18
## 2      5        Up 4.952199e-12 1.914428e-09
## 3      6        Up 6.780738e-12 1.914428e-09
## 4      5        Up 1.153938e-10 2.443465e-08
## 5     13        Up 1.573749e-07 2.221608e-05
## 6     26        Up 3.311013e-07 4.006326e-05
## 7     58        Up 8.763981e-07 9.278865e-05
## 8     24        Up 1.656878e-06 1.559307e-04</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-3.png" width="672" /></p>
<pre><code>## Cluster: 2 Contrast: fresh-DMSO Num genes: 4756 Num DE: 16 
##                                                                                                          category
## 1                                                                                               GO_R_SMAD_BINDING
## 2                                                                                       GO_HMG_BOX_DOMAIN_BINDING
## 3                                                                                                 GO_SMAD_BINDING
## 4                                                                                GO_CAMP_RESPONSE_ELEMENT_BINDING
## 5 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 6                                                                                        GO_RAGE_RECEPTOR_BINDING
## 7                                                                               GO_MHC_CLASS_II_RECEPTOR_ACTIVITY
## 8                                                                                GO_LONG_CHAIN_FATTY_ACID_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 1.017488e-54 8.618127e-52
## 2      5        Up 1.695466e-17 7.180300e-15
## 3     26        Up 6.609728e-16 1.866147e-13
## 4      5        Up 3.093258e-15 6.549974e-13
## 5     58        Up 2.998428e-14 5.079338e-12
## 6      9        Up 1.814293e-13 2.561177e-11
## 7      6        Up 7.331462e-12 8.871069e-10
## 8      5        Up 9.681998e-10 1.025082e-07</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-4.png" width="672" /></p>
<pre><code>## Cluster: 3 Contrast: fresh-DMSO Num genes: 4756 Num DE: 1 
##                                              category NGenes Direction
## 1 GO_PHOSPHATIDYLINOSITOL_3_4_5_TRISPHOSPHATE_BINDING     12        Up
## 2                          GO_PEPTIDE_ANTIGEN_BINDING     17        Up
## 3                  GO_CXCR_CHEMOKINE_RECEPTOR_BINDING      6        Up
##         PValue         FDR
## 1 8.794747e-07 0.000248305
## 2 2.902878e-05 0.006146843
## 3 2.972816e-04 0.035971069</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-5.png" width="672" /></p>
<pre><code>## Cluster: 4 Contrast: fresh-DMSO Num genes: 4756 Num DE: 3 
##                                     category NGenes Direction       PValue
## 1                             GO_IGG_BINDING      5        Up 5.590511e-05
## 2 GO_ACYLGLYCEROL_O_ACYLTRANSFERASE_ACTIVITY      5        Up 6.815654e-05
## 3   GO_SERINE_TYPE_CARBOXYPEPTIDASE_ACTIVITY      6        Up 1.386371e-04
## 4          GO_MHC_CLASS_II_RECEPTOR_ACTIVITY      6        Up 1.936765e-04
## 5                  GO_IMMUNOGLOBULIN_BINDING      8        Up 2.098191e-04
## 6               GO_CARBOXYPEPTIDASE_ACTIVITY      7        Up 5.062926e-04
## 7       GO_SERINE_TYPE_EXOPEPTIDASE_ACTIVITY      7        Up 5.887839e-04
## 8              GO_O_ACYLTRANSFERASE_ACTIVITY      7        Up 6.642764e-04
##           FDR
## 1 0.007891939
## 2 0.008246941
## 3 0.014678204
## 4 0.017771675
## 5 0.017771675
## 6 0.038984530
## 7 0.041558331
## 8 0.043280164</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-6.png" width="672" /></p>
<pre><code>## Cluster: 5 Contrast: fresh-DMSO Num genes: 4756 Num DE: 4 
##                                              category NGenes Direction
## 1                  GO_CXCR_CHEMOKINE_RECEPTOR_BINDING      6        Up
## 2                                 GO_COLLAGEN_BINDING     10        Up
## 3                               GO_CHEMOKINE_ACTIVITY     16        Up
## 4                                   GO_R_SMAD_BINDING     10        Up
## 5  GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 6 GO_PHOSPHATIDYLINOSITOL_3_4_5_TRISPHOSPHATE_BINDING     12        Up
##         PValue          FDR
## 1 9.326749e-11 7.899756e-08
## 2 1.470949e-05 4.152979e-03
## 3 2.530683e-05 5.358722e-03
## 4 5.069952e-05 8.588498e-03
## 5 1.487778e-04 1.664528e-02
## 6 1.572164e-04 1.664528e-02</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-7.png" width="672" /></p>
<pre><code>## Cluster: 6 Contrast: fresh-DMSO Num genes: 4756 Num DE: 6 
##                                                                                                            category
## 1                                                                                                 GO_R_SMAD_BINDING
## 2                                                                                  GO_CAMP_RESPONSE_ELEMENT_BINDING
## 3                                                                                         GO_HMG_BOX_DOMAIN_BINDING
## 4                                                                                                   GO_SMAD_BINDING
## 5                   GO_TRANSCRIPTIONAL_REPRESSOR_ACTIVITY_RNA_POLYMERASE_II_ACTIVATING_TRANSCRIPTION_FACTOR_BINDING
## 6   GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 7                                                      GO_RNA_POLYMERASE_II_ACTIVATING_TRANSCRIPTION_FACTOR_BINDING
## 8 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_TRANSCRIPTION_REGULATORY_REGION_SEQUENCE_SPECIFIC_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 2.367825e-62 2.005548e-59
## 2      5        Up 2.666747e-34 1.129367e-31
## 3      5        Up 5.646842e-32 1.594292e-29
## 4     26        Up 2.706861e-21 5.731779e-19
## 5     14        Up 5.858343e-16 9.628128e-14
## 6     58        Up 6.820398e-16 9.628128e-14
## 7     14        Up 3.268195e-13 3.954517e-11
## 8     82        Up 8.845510e-10 9.365183e-08</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-8.png" width="672" /></p>
<pre><code>## Cluster: 7 Contrast: fresh-DMSO Num genes: 4756 Num DE: 92 
##                                                                                                            category
## 1                                                                                                 GO_R_SMAD_BINDING
## 2                                                                                                   GO_SMAD_BINDING
## 3   GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 4                                                                                GO_MAP_KINASE_PHOSPHATASE_ACTIVITY
## 5                                                  GO_RNA_POLYMERASE_II_CORE_PROMOTER_SEQUENCE_SPECIFIC_DNA_BINDING
## 6 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_TRANSCRIPTION_REGULATORY_REGION_SEQUENCE_SPECIFIC_BINDING
## 7                                                                      GO_CORE_PROMOTER_PROXIMAL_REGION_DNA_BINDING
## 8        GO_TRANSCRIPTION_FACTOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 3.836351e-27 3.249389e-24
## 2     26        Up 5.976624e-10 2.166623e-07
## 3     58        Up 7.673988e-10 2.166623e-07
## 4      6        Up 1.584677e-07 3.355553e-05
## 5     25        Up 6.632929e-07 1.123618e-04
## 6     82        Up 8.026180e-06 1.133029e-03
## 7    102        Up 3.855990e-05 4.220541e-03
## 8     89        Up 3.986343e-05 4.220541e-03</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-9.png" width="672" /></p>
<pre><code>## Cluster: 8 Contrast: fresh-DMSO Num genes: 4756 Num DE: 308 
##                                  category NGenes Direction       PValue
## 1       GO_MHC_CLASS_II_RECEPTOR_ACTIVITY      6        Up 1.956429e-58
## 2              GO_PEPTIDE_ANTIGEN_BINDING     17        Up 4.984973e-22
## 3 GO_MHC_CLASS_II_PROTEIN_COMPLEX_BINDING     12        Up 4.031053e-18
## 4          GO_MHC_PROTEIN_COMPLEX_BINDING     15        Up 9.972236e-13
## 5                      GO_ANTIGEN_BINDING     45        Up 5.028906e-12
## 6                 GO_S100_PROTEIN_BINDING      9        Up 8.821407e-08
## 7                  GO_FIBRONECTIN_BINDING      5        Up 8.124173e-06
## 8            GO_MISFOLDED_PROTEIN_BINDING      7        Up 9.740536e-06
##            FDR
## 1 1.657095e-55
## 2 2.111136e-19
## 3 1.138101e-15
## 4 1.689297e-10
## 5 7.099139e-10
## 6 9.339664e-06
## 7 7.645749e-04
## 8 8.250234e-04</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-10.png" width="672" /></p>
<pre><code>## Cluster: 0 Contrast: fresh-PSC Num genes: 4756 Num DE: 16 
##                            category NGenes Direction       PValue          FDR
## 1  GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up 6.651469e-29 5.633794e-26
## 2          GO_RAGE_RECEPTOR_BINDING      9        Up 9.341843e-24 3.956271e-21
## 3 GO_MHC_CLASS_II_RECEPTOR_ACTIVITY      6        Up 1.024998e-13 1.901272e-11
## 4             GO_FATTY_ACID_BINDING     10        Up 1.122357e-13 1.901272e-11
## 5    GO_MONOCARBOXYLIC_ACID_BINDING     11        Up 1.704079e-12 2.405591e-10
## 6             GO_CHEMOKINE_ACTIVITY     16        Up 5.691750e-12 6.887018e-10
## 7     GO_CHEMOKINE_RECEPTOR_BINDING     20        Up 1.389672e-09 1.307836e-07
## 8 GO_CCR_CHEMOKINE_RECEPTOR_BINDING     12        Up 2.904749e-09 2.460323e-07</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-11.png" width="672" /></p>
<pre><code>## Cluster: 1 Contrast: fresh-PSC Num genes: 4756 Num DE: 21 
##                                             category NGenes Direction
## 1                   GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up
## 2                           GO_RAGE_RECEPTOR_BINDING      9        Up
## 3 GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 4                              GO_CHEMOKINE_ACTIVITY     16        Up
## 5                              GO_FATTY_ACID_BINDING     10        Up
## 6                     GO_MONOCARBOXYLIC_ACID_BINDING     11        Up
## 7                      GO_CHEMOKINE_RECEPTOR_BINDING     20        Up
## 8                                     GO_IGG_BINDING      5        Up
##         PValue          FDR
## 1 3.374894e-22 2.858535e-19
## 2 1.766447e-21 7.480903e-19
## 3 7.578659e-11 1.604781e-08
## 4 1.581671e-10 2.679351e-08
## 5 2.421248e-10 3.417995e-08
## 6 3.122440e-09 3.778153e-07
## 7 2.345237e-08 2.207129e-06
## 8 2.919832e-07 2.473098e-05</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-12.png" width="672" /></p>
<pre><code>## Cluster: 2 Contrast: fresh-PSC Num genes: 4756 Num DE: 19 
##                                                                                                          category
## 1                                                                                               GO_R_SMAD_BINDING
## 2                                                                                        GO_ACTIN_MONOMER_BINDING
## 3                                                                                        GO_RAGE_RECEPTOR_BINDING
## 4                                                                                       GO_HMG_BOX_DOMAIN_BINDING
## 5                                                                                                 GO_SMAD_BINDING
## 6 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 7                                                                                GO_CAMP_RESPONSE_ELEMENT_BINDING
## 8                                                                               GO_CCR_CHEMOKINE_RECEPTOR_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 3.146026e-13 2.664684e-10
## 2      6        Up 2.756223e-08 1.167260e-05
## 3      9        Up 2.847086e-07 8.038272e-05
## 4      5        Up 2.428130e-06 4.113253e-04
## 5     26        Up 6.505066e-05 7.871130e-03
## 6     58        Up 1.144835e-04 1.212094e-02
## 7      5        Up 3.857930e-04 3.267667e-02
## 8     12        Up 4.920288e-04 3.788622e-02</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-13.png" width="672" /></p>
<pre><code>## Cluster: 3 Contrast: fresh-PSC Num genes: 4756 Num DE: 19 
##                                             category NGenes Direction
## 1                           GO_RAGE_RECEPTOR_BINDING      9        Up
## 2                   GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up
## 3                         GO_PEPTIDE_ANTIGEN_BINDING     17        Up
## 4 GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 5                              GO_FATTY_ACID_BINDING     10        Up
## 6                     GO_MONOCARBOXYLIC_ACID_BINDING     11        Up
## 7             GO_RECEPTOR_SIGNALING_PROTEIN_ACTIVITY     45        Up
## 8          GO_NUCLEOSIDE_DIPHOSPHATE_KINASE_ACTIVITY      5        Up
##         PValue          FDR
## 1 2.354824e-11 9.972678e-09
## 2 1.068235e-09 2.261988e-07
## 3 6.061870e-09 8.557339e-07
## 4 8.594482e-08 9.099408e-06
## 5 3.457625e-06 2.928609e-04
## 6 9.513922e-06 7.258019e-04
## 7 2.036984e-05 1.327174e-03
## 8 6.434710e-05 3.892999e-03</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-14.png" width="672" /></p>
<pre><code>## Cluster: 4 Contrast: fresh-PSC Num genes: 4756 Num DE: 19 
##                                category NGenes Direction       PValue
## 1      GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up 4.254675e-14
## 2              GO_RAGE_RECEPTOR_BINDING      9        Up 3.637421e-13
## 3                 GO_FATTY_ACID_BINDING     10        Up 1.231460e-08
## 4        GO_MONOCARBOXYLIC_ACID_BINDING     11        Up 1.133599e-07
## 5 GO_STRUCTURAL_CONSTITUENT_OF_RIBOSOME    153        Up 3.647666e-05
## 6                 GO_CHEMOKINE_ACTIVITY     16        Up 6.562860e-05
## 7                GO_CALCIUM_ION_BINDING    104        Up 2.994959e-04
## 8          GO_SERINE_HYDROLASE_ACTIVITY     36        Up 4.615439e-04
##            FDR
## 1 3.603710e-11
## 2 1.540448e-10
## 3 2.607616e-06
## 4 1.920318e-05
## 5 4.413676e-03
## 6 6.032569e-03
## 7 2.078763e-02
## 8 2.789955e-02</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-15.png" width="672" /></p>
<pre><code>## Cluster: 5 Contrast: fresh-PSC Num genes: 4756 Num DE: 16 
##                                             category NGenes Direction
## 1 GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 2                           GO_RAGE_RECEPTOR_BINDING      9        Up
## 3                   GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up
## 4                      GO_LIPOPOLYSACCHARIDE_BINDING      9        Up
## 5                         GO_VIRUS_RECEPTOR_ACTIVITY     19        Up
## 6                              GO_FATTY_ACID_BINDING     10        Up
## 7   GO_PHOSPHATIDYLINOSITOL_3_4_BISPHOSPHATE_BINDING      9        Up
## 8             GO_RECEPTOR_SIGNALING_PROTEIN_ACTIVITY     45        Up
##         PValue          FDR
## 1 1.019089e-12 8.631685e-10
## 2 1.216446e-10 5.151648e-08
## 3 1.021816e-07 2.163696e-05
## 4 3.379612e-06 5.247555e-04
## 5 2.578853e-05 2.862549e-03
## 6 3.290834e-05 2.862549e-03
## 7 3.379633e-05 2.862549e-03
## 8 9.665090e-05 7.442119e-03</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-16.png" width="672" /></p>
<pre><code>## Cluster: 6 Contrast: fresh-PSC Num genes: 4756 Num DE: 28 
##                            category NGenes Direction       PValue          FDR
## 1          GO_RAGE_RECEPTOR_BINDING      9        Up 8.850627e-11 7.496481e-08
## 2  GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up 1.153940e-09 4.886937e-07
## 3        GO_PEPTIDE_ANTIGEN_BINDING     17        Up 4.287271e-08 1.210440e-05
## 4             GO_CHEMOKINE_ACTIVITY     16        Up 1.025628e-06 2.171767e-04
## 5 GO_MHC_CLASS_II_RECEPTOR_ACTIVITY      6        Up 1.081751e-05 1.527072e-03
## 6     GO_CHEMOKINE_RECEPTOR_BINDING     20        Up 2.312261e-05 2.797835e-03
## 7                 GO_R_SMAD_BINDING     10        Up 3.669754e-05 3.885352e-03
## 8             GO_FATTY_ACID_BINDING     10        Up 4.995858e-05 4.701657e-03</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-17.png" width="672" /></p>
<pre><code>## Cluster: 7 Contrast: fresh-PSC Num genes: 4756 Num DE: 114 
##                           category NGenes Direction       PValue          FDR
## 1 GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up 3.027665e-06 0.0005128865
## 2         GO_RAGE_RECEPTOR_BINDING      9        Up 1.309111e-04 0.0158402416</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-18.png" width="672" /></p>
<pre><code>## Cluster: 8 Contrast: fresh-PSC Num genes: 4756 Num DE: 579 
##                                             category NGenes Direction
## 1                           GO_RAGE_RECEPTOR_BINDING      9        Up
## 2                   GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up
## 3                              GO_FATTY_ACID_BINDING     10        Up
## 4                     GO_MONOCARBOXYLIC_ACID_BINDING     11        Up
## 5                            GO_S100_PROTEIN_BINDING      9        Up
## 6 GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 7                  GO_MHC_CLASS_II_RECEPTOR_ACTIVITY      6        Up
## 8                             GO_CALCIUM_ION_BINDING    104        Up
##         PValue          FDR
## 1 4.733011e-85 4.008860e-82
## 2 6.170322e-70 2.613131e-67
## 3 3.900974e-34 8.260312e-32
## 4 1.551354e-30 2.627993e-28
## 5 2.393476e-21 3.378790e-19
## 6 3.248643e-16 3.930857e-14
## 7 9.305548e-16 9.852249e-14
## 8 5.222678e-15 4.915120e-13</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-19.png" width="672" /></p>
<pre><code>## Cluster: 0 Contrast: fresh-CS10 Num genes: 4756 Num DE: 8 
##                                                                                                            category
## 1                                                                                                 GO_R_SMAD_BINDING
## 2                                                                                         GO_HMG_BOX_DOMAIN_BINDING
## 3   GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 4                                                                                        GO_PEPTIDE_ANTIGEN_BINDING
## 5                                                                                GO_MAP_KINASE_PHOSPHATASE_ACTIVITY
## 6 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_TRANSCRIPTION_REGULATORY_REGION_SEQUENCE_SPECIFIC_BINDING
## 7                                                                                                   GO_SMAD_BINDING
## 8                                                                                                GO_ANTIGEN_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 9.378151e-17 7.943294e-14
## 2      5        Up 2.165527e-09 9.171006e-07
## 3     58        Up 2.053371e-07 5.797352e-05
## 4     17        Up 7.645361e-07 1.618905e-04
## 5      6        Up 5.769051e-06 9.772772e-04
## 6     82        Up 1.370111e-05 1.664214e-03
## 7     26        Up 1.375384e-05 1.664214e-03
## 8     45        Up 2.007591e-05 2.125537e-03</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-20.png" width="672" /></p>
<pre><code>## Cluster: 1 Contrast: fresh-CS10 Num genes: 4756 Num DE: 9 
##                                                                                                            category
## 1                                                                                                 GO_R_SMAD_BINDING
## 2                                                                                         GO_HMG_BOX_DOMAIN_BINDING
## 3   GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 4                                                                                GO_MAP_KINASE_PHOSPHATASE_ACTIVITY
## 5 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_TRANSCRIPTION_REGULATORY_REGION_SEQUENCE_SPECIFIC_BINDING
## 6                                                                                                   GO_SMAD_BINDING
## 7        GO_TRANSCRIPTION_FACTOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 8                   GO_TRANSCRIPTIONAL_REPRESSOR_ACTIVITY_RNA_POLYMERASE_II_ACTIVATING_TRANSCRIPTION_FACTOR_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 2.351131e-30 1.991408e-27
## 2      5        Up 6.458851e-18 2.735323e-15
## 3     58        Up 9.867639e-15 2.785963e-12
## 4      6        Up 1.911115e-11 4.046785e-09
## 5     82        Up 1.970139e-09 2.902086e-07
## 6     26        Up 2.055787e-09 2.902086e-07
## 7     89        Up 3.304935e-09 3.998972e-07
## 8     14        Up 7.634344e-08 8.082862e-06</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-21.png" width="672" /></p>
<pre><code>## Cluster: 2 Contrast: fresh-CS10 Num genes: 4756 Num DE: 18 
##                                                                                                            category
## 1                                                                                                 GO_R_SMAD_BINDING
## 2   GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 3                                                                                GO_MAP_KINASE_PHOSPHATASE_ACTIVITY
## 4                                                                                                   GO_SMAD_BINDING
## 5                                                  GO_RNA_POLYMERASE_II_CORE_PROMOTER_SEQUENCE_SPECIFIC_DNA_BINDING
## 6 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_TRANSCRIPTION_REGULATORY_REGION_SEQUENCE_SPECIFIC_BINDING
## 7                                                                                         GO_HMG_BOX_DOMAIN_BINDING
## 8        GO_TRANSCRIPTION_FACTOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 1.763399e-35 1.493599e-32
## 2     58        Up 4.796461e-17 2.031301e-14
## 3      6        Up 5.503268e-12 1.553756e-09
## 4     26        Up 2.486064e-11 5.264241e-09
## 5     25        Up 1.298407e-10 2.199501e-08
## 6     82        Up 4.198135e-10 5.926367e-08
## 7      5        Up 1.119063e-08 1.354066e-06
## 8     89        Up 1.637168e-08 1.733352e-06</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-22.png" width="672" /></p>
<pre><code>## Cluster: 3 Contrast: fresh-CS10 Num genes: 4756 Num DE: 5 
##                                                 category NGenes Direction
## 1 GO_G_PROTEIN_COUPLED_CHEMOATTRACTANT_RECEPTOR_ACTIVITY      6        Up
## 2                             GO_PEPTIDE_ANTIGEN_BINDING     17        Up
## 3                          GO_CYTOKINE_RECEPTOR_ACTIVITY     24        Up
## 4                           GO_GLYCOSAMINOGLYCAN_BINDING     27        Up
## 5                           GO_PEPTIDE_RECEPTOR_ACTIVITY     16        Up
## 6     GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 7              GO_PHOSPHATIDYLINOSITOL_3_KINASE_ACTIVITY     18        Up
## 8                   GO_CARBOHYDRATE_TRANSPORTER_ACTIVITY      9        Up
##         PValue          FDR
## 1 1.922097e-08 1.628016e-05
## 2 2.653455e-06 1.112634e-03
## 3 3.940852e-06 1.112634e-03
## 4 3.835094e-04 3.248324e-02
## 5 5.073399e-04 3.580974e-02
## 6 5.840136e-04 3.805073e-02
## 7 6.669248e-04 3.930418e-02
## 8 6.960598e-04 3.930418e-02</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-23.png" width="672" /></p>
<pre><code>## Cluster: 4 Contrast: fresh-CS10 Num genes: 4756 Num DE: 17 
##                                             category NGenes Direction
## 1 GO_SIGNALING_PATTERN_RECOGNITION_RECEPTOR_ACTIVITY      9        Up
## 2                     GO_SIGNALING_RECEPTOR_ACTIVITY    156        Up
## 3    GO_G_PROTEIN_BETA_GAMMA_SUBUNIT_COMPLEX_BINDING      8        Up
## 4        GO_SUGAR_TRANSMEMBRANE_TRANSPORTER_ACTIVITY      7        Up
## 5                               GO_RECEPTOR_ACTIVITY    215        Up
##         PValue          FDR
## 1 1.538678e-06 0.0004344201
## 2 1.341988e-05 0.0028416593
## 3 1.898078e-04 0.0262009856
## 4 2.012054e-04 0.0262009856
## 5 2.165371e-04 0.0262009856</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-24.png" width="672" /></p>
<pre><code>## Cluster: 5 Contrast: fresh-CS10 Num genes: 4756 Num DE: 12 
##                             category NGenes Direction       PValue       FDR
## 1                  GO_R_SMAD_BINDING     10        Up 1.928926e-05 0.0163380
## 2         GO_PEPTIDE_ANTIGEN_BINDING     17        Up 4.697037e-05 0.0188623
## 3 GO_MAP_KINASE_PHOSPHATASE_ACTIVITY      6        Up 6.680863e-05 0.0188623</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-25.png" width="672" /></p>
<pre><code>## Cluster: 6 Contrast: fresh-CS10 Num genes: 4756 Num DE: 19 
##                                                                                                            category
## 1                                                                                                 GO_R_SMAD_BINDING
## 2                                                                                         GO_HMG_BOX_DOMAIN_BINDING
## 3                                                                                  GO_CAMP_RESPONSE_ELEMENT_BINDING
## 4                                                                                                   GO_SMAD_BINDING
## 5   GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 6                   GO_TRANSCRIPTIONAL_REPRESSOR_ACTIVITY_RNA_POLYMERASE_II_ACTIVATING_TRANSCRIPTION_FACTOR_BINDING
## 7                                                                                GO_MAP_KINASE_PHOSPHATASE_ACTIVITY
## 8 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_TRANSCRIPTION_REGULATORY_REGION_SEQUENCE_SPECIFIC_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 7.601816e-52 6.438738e-49
## 2      5        Up 2.004703e-20 8.489917e-18
## 3      5        Up 2.697768e-19 7.616698e-17
## 4     26        Up 1.392488e-17 2.948592e-15
## 5     58        Up 6.925128e-17 1.173117e-14
## 6     14        Up 7.139213e-11 1.007819e-08
## 7      6        Up 1.703831e-10 2.061636e-08
## 8     82        Up 3.388324e-10 3.587388e-08</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-26.png" width="672" /></p>
<pre><code>## Cluster: 7 Contrast: fresh-CS10 Num genes: 4756 Num DE: 33 
##                                                                                                          category
## 1                                                                                               GO_R_SMAD_BINDING
## 2                                                GO_RNA_POLYMERASE_II_CORE_PROMOTER_SEQUENCE_SPECIFIC_DNA_BINDING
## 3                                                                              GO_MAP_KINASE_PHOSPHATASE_ACTIVITY
## 4 GO_TRANSCRIPTIONAL_ACTIVATOR_ACTIVITY_RNA_POLYMERASE_II_CORE_PROMOTER_PROXIMAL_REGION_SEQUENCE_SPECIFIC_BINDING
## 5                                                                  GO_CORE_PROMOTER_SEQUENCE_SPECIFIC_DNA_BINDING
## 6                                                                                        GO_CORE_PROMOTER_BINDING
##   NGenes Direction       PValue          FDR
## 1     10        Up 6.889623e-12 5.835511e-09
## 2     25        Up 6.340945e-09 2.685390e-06
## 3      6        Up 1.130845e-07 3.192754e-05
## 4     58        Up 1.989822e-05 4.213449e-03
## 5     46        Up 9.346393e-05 1.583279e-02
## 6     71        Up 1.590669e-04 2.245494e-02</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/pval%20lfc-27.png" width="672" /></p>
<pre><code>## Cluster: 8 Contrast: fresh-CS10 Num genes: 4756 Num DE: 416 
##                            category NGenes Direction       PValue          FDR
## 1          GO_RAGE_RECEPTOR_BINDING      9        Up 7.163028e-26 3.033542e-23
## 2  GO_LONG_CHAIN_FATTY_ACID_BINDING      5        Up 1.005865e-24 2.839892e-22
## 3    GO_MONOCARBOXYLIC_ACID_BINDING     11        Up 3.676774e-24 7.785568e-22
## 4             GO_FATTY_ACID_BINDING     10        Up 3.224566e-22 5.462414e-20
## 5           GO_ORGANIC_ACID_BINDING     33        Up 1.100163e-12 1.553063e-10
## 6        GO_PEPTIDE_ANTIGEN_BINDING     17        Up 1.204752e-10 1.457750e-08
## 7            GO_CALCIUM_ION_BINDING    104        Up 3.151178e-09 3.336309e-07
## 8 GO_MHC_CLASS_II_RECEPTOR_ACTIVITY      6        Up 2.893871e-08 2.723455e-06</code></pre>
<p>Summarize differential expression analysis</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># DE genes (per cluster and mean)</span>
<span class="co">#n_de &lt;- lapply(res, function(y) vapply(y, function(x) sum(x$adj.P.Val &lt; 0.05), numeric(1)))</span>
n_de &lt;-<span class="st"> </span><span class="kw">lapply</span>(res, function(y) <span class="kw">vapply</span>(y, function(x) <span class="kw">sum</span>(x$PValue &lt;<span class="st"> </span><span class="fl">0.05</span>), <span class="kw">numeric</span>(<span class="dv">1</span>)))
n_de_cl &lt;-<span class="st"> </span><span class="kw">lapply</span>(res, function(y) <span class="kw">vapply</span>(y, function(x) <span class="kw">nrow</span>(x), <span class="kw">numeric</span>(<span class="dv">1</span>)))
mean_n_de &lt;-<span class="st"> </span><span class="kw">lapply</span>(n_de, function(x) <span class="kw">mean</span>(x))
mean_mean_n_de &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">unlist</span>(mean_n_de))/n_genes
min_mean_n_de &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">unlist</span>(mean_n_de))/n_genes
max_mean_n_de &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">unlist</span>(mean_n_de))/n_genes

<span class="co"># Genes with lfc &gt; 1</span>
n_genes_lfc1 &lt;-<span class="st"> </span><span class="kw">lapply</span>(res, function(y) <span class="kw">vapply</span>(y, function(x) <span class="kw">sum</span>(<span class="kw">abs</span>(x$logFC) &gt;<span class="st"> </span><span class="dv">1</span>), <span class="kw">numeric</span>(<span class="dv">1</span>)))
mean_n_genes_lfc1 &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">unlist</span>(n_genes_lfc1))/n_genes
min_n_genes_lfc1 &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">unlist</span>(n_genes_lfc1))/n_genes
max_n_genes_lfc1 &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">unlist</span>(n_genes_lfc1))/n_genes

<span class="co"># DE genes overlap between celltypes (celltype specific de genes)</span>
<span class="co"># Genes are &quot;overlapping&quot; if they are present in all clusters with at least 10% of all cells</span>
de_overlap &lt;-<span class="st"> </span><span class="kw">lapply</span>(result, function(x){
  result2 &lt;-<span class="st"> </span>x[<span class="kw">table</span>(<span class="kw">colData</span>(sce)[, celltype]) &gt;<span class="st"> </span><span class="kw">ncol</span>(sce) *<span class="st"> </span><span class="fl">0.1</span>]
  de_overlap &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">Reduce</span>(intersect, result2))
  de_overlap
})

mean_de_overlap &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">unlist</span>(de_overlap))/n_genes
min_de_overlap &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">unlist</span>(de_overlap))/n_genes
max_de_overlap &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">unlist</span>(de_overlap))/n_genes

<span class="co">#Genes unique to single celltypes</span>
unique_genes_matrix &lt;-<span class="st"> </span><span class="ot">NULL</span>
unique_genes &lt;-<span class="st"> </span><span class="ot">NULL</span>
cb &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">names</span>(result[[<span class="dv">1</span>]]))
unique_genes &lt;-<span class="st"> </span><span class="kw">lapply</span>(result,function(x){
  for( i in <span class="dv">1</span>:cb ){
    unique_genes[i] &lt;-<span class="kw">as.numeric</span>(<span class="kw">length</span>(<span class="kw">setdiff</span>(<span class="kw">unlist</span>(x[i]),<span class="kw">unlist</span>(x[-i]))))
  }
  unique_genes_matrix &lt;-<span class="st"> </span><span class="kw">cbind</span>(unique_genes_matrix, unique_genes)
  unique_genes_matrix
})

unique_genes &lt;-<span class="st"> </span><span class="kw">Reduce</span>(<span class="st">&#39;cbind&#39;</span>, unique_genes)
<span class="kw">colnames</span>(unique_genes) &lt;-<span class="st"> </span><span class="kw">names</span>(result)
<span class="kw">rownames</span>(unique_genes) &lt;-<span class="st"> </span><span class="kw">names</span>(result[[<span class="dv">1</span>]])

<span class="co"># Relative cluster specificity (unique/overlapping)</span>
rel_spec1 &lt;-<span class="st"> </span><span class="ot">NULL</span>
for( i in <span class="dv">1</span>:<span class="kw">dim</span>(unique_genes)[<span class="dv">2</span>] ){
  rel_spec &lt;-<span class="st"> </span>unique_genes[,i]/de_overlap[[i]]
  rel_spec1 &lt;-<span class="st"> </span><span class="kw">cbind</span>(rel_spec1,rel_spec)
}

mean_rel_spec &lt;-<span class="st"> </span><span class="kw">mean</span>(rel_spec1)
min_rel_spec &lt;-<span class="st"> </span><span class="kw">min</span>(rel_spec1)
max_rel_spec &lt;-<span class="st"> </span><span class="kw">max</span>(rel_spec1)</code></pre></div>
</div>
<div id="celltype-specific-de-distributions" class="section level3">
<h3>Celltype specific DE distributions</h3>
<p>How similar is the batch effect between celltypes. Do we have similar logFC distributions or different?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">combine_folds &lt;-<span class="st"> </span>function(cont_var){
  <span class="co">#extract the contrast of interest and change log2fold colums names to be unique</span>
  B &lt;-<span class="st"> </span>res[[cont_var]] 
  new_name &lt;-<span class="st"> </span>function(p){
    <span class="kw">colnames</span>(B[[p]])[<span class="dv">3</span>] &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;logFC_&quot;</span>, p)
    <span class="kw">return</span>(B[[p]][,<span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)])
    }
  B_new_names &lt;-<span class="st"> </span><span class="kw">lapply</span>(<span class="kw">names</span>(B),new_name)
  <span class="kw">names</span>(B_new_names) &lt;-<span class="st"> </span><span class="kw">names</span>(B)
  <span class="co">#combine log2fold colums</span>
  Folds &lt;-<span class="st"> </span><span class="kw">Reduce</span>(function(...){<span class="kw">inner_join</span>(..., <span class="dt">by=</span><span class="st">&quot;gene&quot;</span>)}, B_new_names)
}

all_folds &lt;-<span class="st"> </span><span class="kw">lapply</span>(cs, combine_folds)

<span class="co">#define pannels for pairs() function</span>
panel.cor &lt;-<span class="st"> </span>function(x, y, <span class="dt">digits =</span> <span class="dv">2</span>, cex.cor){
  usr &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">&quot;usr&quot;</span>); <span class="kw">on.exit</span>(<span class="kw">par</span>(usr))
  <span class="kw">par</span>(<span class="dt">usr =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))
  r &lt;-<span class="st"> </span><span class="kw">abs</span>(<span class="kw">cor</span>(x, y))
  txt &lt;-<span class="st"> </span><span class="kw">format</span>(<span class="kw">c</span>(r, <span class="fl">0.123456789</span>), <span class="dt">digits=</span>digits)[<span class="dv">1</span>]
  test &lt;-<span class="st"> </span><span class="kw">cor.test</span>(x,y)
  Signif &lt;-<span class="st"> </span><span class="kw">ifelse</span>(<span class="kw">round</span>(test$p.value, <span class="dv">3</span>) &lt;<span class="st"> </span><span class="fl">0.001</span>,
                   <span class="st">&quot;p&lt;0.001&quot;</span>,
                   <span class="kw">paste</span>(<span class="st">&quot;p=&quot;</span>,<span class="kw">round</span>(test$p.value,<span class="dv">3</span>)))  
  <span class="kw">text</span>(<span class="fl">0.5</span>, <span class="fl">0.25</span>, <span class="kw">paste</span>(<span class="st">&quot;r=&quot;</span>,txt), <span class="dt">cex =</span> <span class="dv">3</span>)
  <span class="kw">text</span>(.<span class="dv">5</span>, .<span class="dv">75</span>, Signif, <span class="dt">cex =</span> <span class="dv">3</span>)
}

panel.smooth &lt;-<span class="st"> </span>function (x, y, <span class="dt">col =</span> <span class="st">&quot;blue&quot;</span>, <span class="dt">bg =</span> <span class="ot">NA</span>, <span class="dt">pch =</span> <span class="dv">18</span>, <span class="dt">cex =</span> <span class="fl">1.5</span>, 
                          <span class="dt">col.smooth =</span> <span class="st">&quot;red&quot;</span>, <span class="dt">span =</span> <span class="dv">2</span>/<span class="dv">3</span>, <span class="dt">iter =</span> <span class="dv">3</span>, ...){
  <span class="kw">points</span>(x, y, <span class="dt">pch =</span> pch, <span class="dt">col =</span> col, <span class="dt">bg =</span> bg, <span class="dt">cex =</span> cex)
  ok &lt;-<span class="st"> </span><span class="kw">is.finite</span>(x) &amp;<span class="st"> </span><span class="kw">is.finite</span>(y)
  if( <span class="kw">any</span>(ok) ) 
    <span class="kw">lines</span>(stats::<span class="kw">lowess</span>(x[ok], y[ok], <span class="dt">f =</span> span, <span class="dt">iter =</span> iter), 
          <span class="dt">col =</span> col.smooth, ...)
}

panel.hist &lt;-<span class="st"> </span>function(x, ...){
  usr &lt;-<span class="st"> </span><span class="kw">par</span>(<span class="st">&quot;usr&quot;</span>); <span class="kw">on.exit</span>(<span class="kw">par</span>(usr))
  <span class="kw">par</span>(<span class="dt">usr =</span> <span class="kw">c</span>(usr[<span class="dv">1</span>:<span class="dv">2</span>], <span class="dv">0</span>, <span class="fl">1.5</span>) )
  h &lt;-<span class="st"> </span><span class="kw">hist</span>(x, <span class="dt">plot =</span> <span class="ot">FALSE</span>)
  breaks &lt;-<span class="st"> </span>h$breaks
  nB &lt;-<span class="st"> </span><span class="kw">length</span>(breaks)
  y &lt;-<span class="st"> </span>h$counts
  y &lt;-<span class="st"> </span>y/<span class="kw">max</span>(y)
  <span class="kw">rect</span>(breaks[-nB], <span class="dv">0</span>, breaks[-<span class="dv">1</span>], y, <span class="dt">col=</span><span class="st">&quot;cyan&quot;</span>, ...)
}
<span class="co">#plot correlations</span>
<span class="kw">lapply</span>(<span class="kw">names</span>(all_folds), function(x) <span class="kw">pairs</span>(all_folds[[x]][,-<span class="dv">1</span>],
                                           <span class="dt">lower.panel =</span> panel.smooth, 
                                           <span class="dt">upper.panel =</span> panel.cor, 
                                           <span class="dt">diag.panel =</span> panel.hist, <span class="dt">main =</span> x))</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/ct%20de%20dist%20-1.png" width="1920" /><img src="batch_effect_pbmc_roche_files/figure-html/ct%20de%20dist%20-2.png" width="1920" /><img src="batch_effect_pbmc_roche_files/figure-html/ct%20de%20dist%20-3.png" width="1920" /></p>
<pre><code>## [[1]]
## NULL
## 
## [[2]]
## NULL
## 
## [[3]]
## NULL</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#extract correlation coefficients</span>
<span class="co"># correlation coefficients from celltype specific gege logFC</span>

lfc_cor_list &lt;-<span class="kw">lapply</span>(<span class="kw">names</span>(all_folds), function(com){
  exclude &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">table</span>(<span class="kw">colData</span>(sce)[,celltype]) &lt;<span class="st"> </span><span class="dv">100</span>)
  r &lt;-<span class="st"> </span><span class="kw">cor</span>(all_folds[[com]][, -<span class="kw">c</span>(<span class="dv">1</span>, (exclude +<span class="st"> </span><span class="dv">1</span>))])
  mean_r &lt;-<span class="st"> </span>(<span class="kw">sum</span>(r) -<span class="st"> </span><span class="kw">ncol</span>(r))/<span class="st"> </span>(<span class="kw">ncol</span>(r)^<span class="dv">2</span> -<span class="st"> </span><span class="kw">ncol</span>(r))
})

mean_lfc_cor &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">unlist</span>(lfc_cor_list))</code></pre></div>
</div>
</div>
<div id="batch-categorization" class="section level2 tabset tabset-pills">
<h2>Batch categorization</h2>
<p>How does the batch effect manifest? Can we describe it by “simple” mean shifts of expression levels for some genes for all the cells in a given celltype and batch? Can we “remove” the batch effcet using a linear model with batch, batch and celltype or batch and celltype interacting?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Visualize different models</span>
vis_type &lt;-<span class="st"> </span>function(dim_red){
  g &lt;-<span class="st"> </span><span class="kw">visGroup</span>(sce, batch, <span class="dt">dim_red =</span> dim_red) +<span class="st"> </span>
<span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;unadjusted&quot;</span>)
  g1 &lt;-<span class="st"> </span><span class="kw">visGroup</span>(sce, batch, <span class="dt">dim_red =</span> <span class="kw">paste0</span>(dim_red, <span class="st">&quot;_Xadj1&quot;</span>)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;constant batch effect&quot;</span>)
  g2 &lt;-<span class="st"> </span><span class="kw">visGroup</span>(sce, batch, <span class="dt">dim_red =</span> <span class="kw">paste0</span>(dim_red, <span class="st">&quot;_Xadj2&quot;</span>)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;constant batch effect, different ct composition&quot;</span>)
  g3 &lt;-<span class="st"> </span><span class="kw">visGroup</span>(sce, batch, <span class="dt">dim_red =</span> <span class="kw">paste0</span>(dim_red, <span class="st">&quot;_Xadj3&quot;</span>)) +<span class="st"> </span>
<span class="st">    </span><span class="kw">ggtitle</span>(<span class="st">&quot;celltype and batch effect interact&quot;</span>)
  <span class="kw">do.call</span>(<span class="st">&quot;grid.arrange&quot;</span>, <span class="kw">c</span>(<span class="kw">list</span>(g, g1, g2, g3), <span class="dt">ncol =</span> <span class="dv">2</span>))
}</code></pre></div>
<div id="pca" class="section level3">
<h3>PCA</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vis_type</span>(<span class="st">&quot;PCA&quot;</span>)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/batchtype%20pca-1.png" width="672" /></p>
</div>
<div id="umap" class="section level3">
<h3>UMAP</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">vis_type</span>(<span class="st">&quot;UMAP&quot;</span>)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/batchtype%20umap-1.png" width="672" /></p>
</div>
<div id="cellspecific-mixing-score-1" class="section level3">
<h3>Cellspecific Mixing Score</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># #Cellspecific Mixing score (Batch effect strength after &quot;removal&quot;)</span>
<span class="kw">visHist</span>(sce, <span class="dt">metric =</span> <span class="kw">c</span>(<span class="st">&quot;cms&quot;</span>, <span class="st">&quot;cms.Xadj1&quot;</span>, <span class="st">&quot;cms.Xadj2&quot;</span>, <span class="st">&quot;cms.Xadj3&quot;</span>), <span class="dt">prefix =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p><img src="batch_effect_pbmc_roche_files/figure-html/batchtype%20cms-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">visIntegration</span>(sce, <span class="dt">metric =</span> <span class="st">&quot;cms&quot;</span>, <span class="dt">metric_name =</span> <span class="st">&quot;cms&quot;</span>)</code></pre></div>
<pre><code>## Picking joint bandwidth of 0.0276</code></pre>
<p><img src="batch_effect_pbmc_roche_files/figure-html/batchtype%20cms-2.png" width="672" /></p>
</div>
</div>
<div id="simulation-parameter" class="section level2">
<h2>Simulation parameter</h2>
<p>Extract parameter to use as input into simualation</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#percentage of batch affected genes</span>
cond &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="st">&quot;-.*&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">names</span>(n_de))
cond &lt;-<span class="st"> </span><span class="kw">c</span>(cond, <span class="kw">unique</span>(<span class="kw">gsub</span>(<span class="st">&quot;.*-&quot;</span>, <span class="st">&quot;&quot;</span>, <span class="kw">names</span>(n_de))))
cond &lt;-<span class="st"> </span><span class="kw">unique</span>(cond)
de_be_tab &lt;-<span class="st"> </span>n_de %&gt;%<span class="st"> </span><span class="kw">bind_cols</span>()
de_cl_tab &lt;-<span class="st"> </span>n_de_cl %&gt;%<span class="st"> </span><span class="kw">bind_cols</span>()

de_be &lt;-<span class="st"> </span>cond %&gt;%<span class="st"> </span><span class="kw">map</span>(function(x){
  de_tab &lt;-<span class="st"> </span>de_be_tab[, <span class="kw">grep</span>(x, <span class="kw">colnames</span>(de_be_tab))]
  de_be &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(de_tab)
}) %&gt;%<span class="st"> </span><span class="kw">bind_cols</span>() %&gt;%<span class="st"> </span><span class="kw">set_colnames</span>(cond)

n_cl &lt;-<span class="st"> </span>cond %&gt;%<span class="st"> </span><span class="kw">map</span>(function(x){
  cl_tab &lt;-<span class="st"> </span>de_cl_tab[, <span class="kw">grep</span>(x, <span class="kw">colnames</span>(de_cl_tab))]
  de_cl &lt;-<span class="st"> </span><span class="kw">rowMeans</span>(cl_tab)
}) %&gt;%<span class="st"> </span><span class="kw">bind_cols</span>() %&gt;%<span class="st"> </span><span class="kw">set_colnames</span>(cond)


p_be &lt;-<span class="st"> </span>de_be/n_cl
mean_p_be &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">colMeans</span>(p_be))
min_p_be &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">colMins</span>(<span class="kw">as.matrix</span>(p_be)))
max_p_be &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">colMaxs</span>(<span class="kw">as.matrix</span>(p_be)))
sd_p_be &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">colSds</span>(<span class="kw">as.matrix</span>(p_be)))
if(<span class="kw">is.na</span>(sd_p_be)){ sd_p_be &lt;-<span class="st"> </span><span class="dv">0</span> }


#### Percentage of celltype specific genes &quot;p_ct&quot;
n_de_unique &lt;-<span class="st"> </span><span class="kw">lapply</span>(result,function(x){
  de_genes &lt;-<span class="st"> </span><span class="kw">unlist</span>(x) %&gt;%<span class="st"> </span><span class="kw">unique</span>() %&gt;%<span class="st"> </span><span class="kw">length</span>()
  de_genes &lt;-<span class="st"> </span>de_genes/<span class="kw">length</span>(x)
}) %&gt;%<span class="st"> </span><span class="kw">bind_cols</span>()


rel_spec2 &lt;-<span class="st"> </span><span class="ot">NULL</span>
for(i in <span class="dv">1</span>:<span class="kw">length</span>(de_overlap)){
  rel_spec &lt;-<span class="st"> </span>de_overlap[[i]]/<span class="kw">mean</span>(n_de[[i]][<span class="kw">table</span>(<span class="kw">colData</span>(sce)[, celltype]) &gt;<span class="st"> </span><span class="kw">dim</span>(expr)[<span class="dv">2</span>] *<span class="st"> </span><span class="fl">0.1</span>])
  rel_spec2 &lt;-<span class="st"> </span><span class="kw">cbind</span>(rel_spec2, rel_spec)
}

mean_p_ct &lt;-<span class="st"> </span><span class="dv">1</span> -<span class="st"> </span><span class="kw">mean</span>(rel_spec2)
max_p_ct &lt;-<span class="st"> </span><span class="dv">1</span> -<span class="st"> </span><span class="kw">min</span>(rel_spec2)
min_p_ct &lt;-<span class="st"> </span><span class="dv">1</span> -<span class="st"> </span><span class="kw">max</span>(rel_spec2)
sd_p_ct &lt;-<span class="st"> </span><span class="kw">sd</span>(rel_spec2)
if(<span class="kw">is.na</span>(sd_p_ct)){ sd_p_ct &lt;-<span class="st"> </span><span class="dv">0</span> }

<span class="co"># Logfold change</span>
<span class="co">#logFoldchange batch effect distribution</span>
mean_lfc_cl &lt;-<span class="st"> </span><span class="kw">lapply</span>(res, function(y) <span class="kw">vapply</span>(y, function(x){
  <span class="co">#de_genes &lt;- which(x$adj.P.Val &lt; 0.05)</span>
  de_genes &lt;-<span class="st"> </span><span class="kw">which</span>(x$adj.PValue &lt;<span class="st"> </span><span class="fl">0.05</span>)
  mean_de &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">abs</span>(x[, <span class="st">&quot;logFC&quot;</span>]))}
  , <span class="kw">numeric</span>(<span class="dv">1</span>))) %&gt;%<span class="st"> </span><span class="kw">bind_cols</span>()

mean_lfc_be &lt;-<span class="st"> </span><span class="kw">mean</span>(<span class="kw">colMeans</span>(mean_lfc_cl, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
min_lfc_be &lt;-<span class="st"> </span><span class="kw">min</span>(<span class="kw">colMins</span>(<span class="kw">as.matrix</span>(mean_lfc_cl), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))
max_lfc_be &lt;-<span class="st"> </span><span class="kw">max</span>(<span class="kw">colMaxs</span>(<span class="kw">as.matrix</span>(mean_lfc_cl), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</code></pre></div>
</div>
<div id="summarize-batch-effect" class="section level2">
<h2>Summarize batch effect</h2>
<ul>
<li>Batch size</li>
<li>Celltype specificity</li>
<li>“Batch genes”</li>
<li>batch type</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#Size? How much of the variance can be attributed to the batch effect?</span>
size &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;batch_genes_1per&quot;</span> =<span class="st"> </span>n_batch_gene,       <span class="co"># 1.variance partition</span>
                   <span class="st">&quot;batch_genes_10per&quot;</span> =<span class="st"> </span>n_batch_gene10,
                   <span class="st">&quot;celltype_gene_1per&quot;</span> =<span class="st"> </span>n_celltype_gene,
                   <span class="st">&quot;relative_batch_celltype&quot;</span> =<span class="st"> </span>n_rel,
                   <span class="st">&quot;mean_var_batch&quot;</span> =<span class="st"> </span>m_batch,
                   <span class="st">&quot;mean_var_celltype&quot;</span> =<span class="st"> </span>m_celltype,
                   <span class="st">&quot;rel_mean_ct_batch&quot;</span> =<span class="st"> </span>m_rel,
                   <span class="st">&quot;mean_cms&quot;</span> =<span class="st"> </span>mean_cms,                    <span class="co">#2.cms</span>
                   <span class="st">&quot;n_cells_cms_0.01&quot;</span> =<span class="st"> </span>n_cms_0<span class="fl">.01</span>,
                   <span class="st">&quot;mean_mean_n_de_genes&quot;</span> =<span class="st"> </span>mean_mean_n_de,  <span class="co">#3.de genes</span>
                   <span class="st">&quot;max_mean_n_de_genes&quot;</span> =<span class="st"> </span>max_mean_n_de,
                   <span class="st">&quot;min_mean_n_de_genes&quot;</span> =<span class="st"> </span>min_mean_n_de,
                   <span class="st">&quot;mean_n_genes_lfc1&quot;</span> =<span class="st"> </span>mean_n_genes_lfc1,
                   <span class="st">&quot;min_n_genes_lfc1&quot;</span> =<span class="st"> </span>min_n_genes_lfc1,
                   <span class="st">&quot;max_n_genes_lfc1&quot;</span> =<span class="st"> </span>max_n_genes_lfc1,
                   <span class="st">&quot;n_cells_total&quot;</span> =<span class="st"> </span><span class="kw">ncol</span>(sce),              <span class="co">#4.general</span>
                   <span class="st">&quot;n_genes_total&quot;</span> =<span class="st"> </span><span class="kw">nrow</span>(sce))


<span class="co">#Celltype-specificity? How celltype/cluster specific are batch effects? </span>
<span class="co"># Differences in size, distribution or abundance? Do we find correlations between lfcs,</span>
<span class="co"># overlap in de genes, pathways? Interaction between ct and be?</span>
celltype &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&#39;mean_rel_abund_diff&#39;</span> =<span class="st"> </span>mean_rel_abund_diff, <span class="co">#1.abundance</span>
                       <span class="st">&#39;min_rel_abund_diff&#39;</span> =<span class="st"> </span>min_rel_abund_diff,
                       <span class="st">&#39;max_rel_abund_diff&#39;</span> =<span class="st"> </span>max_rel_abund_diff,
                       <span class="st">&quot;celltype_var_cms&quot;</span> =<span class="st"> </span>var_cms,                 <span class="co">#2.size/strength</span>
                       <span class="st">&quot;mean_de_overlap&quot;</span> =<span class="st"> </span>mean_de_overlap,
                       <span class="st">&quot;min_de_overlap&quot;</span> =<span class="st"> </span>min_de_overlap,
                       <span class="st">&quot;max_de_overlap&quot;</span> =<span class="st"> </span>max_de_overlap,
                       <span class="st">&quot;mean_rel_cluster_spec&quot;</span>=<span class="st"> </span>mean_rel_spec,
                       <span class="st">&quot;min_rel_cluster_spec&quot;</span>=<span class="st"> </span>min_rel_spec,
                       <span class="st">&quot;max_rel_cluster_spec&quot;</span>=<span class="st"> </span>max_rel_spec,
                       <span class="st">&quot;mean_lfc_cor&quot;</span> =<span class="st"> </span>mean_lfc_cor )


sim &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="st">&quot;mean_p_be&quot;</span> =<span class="st"> </span>mean_p_be,
                  <span class="st">&quot;max_p_be&quot;</span> =<span class="st"> </span>max_p_be,
                  <span class="st">&quot;min_p_be&quot;</span> =<span class="st"> </span>min_p_be,
                  <span class="st">&quot;sd_p_be&quot;</span> =<span class="st"> </span>sd_p_be,
                  <span class="st">&quot;mean_lfc_be&quot;</span> =<span class="st"> </span>mean_lfc_be,
                  <span class="st">&quot;min_lfc_be&quot;</span> =<span class="st"> </span>min_lfc_be,
                  <span class="st">&quot;max_lfc_be&quot;</span> =<span class="st"> </span>max_lfc_be,
                  <span class="st">&quot;mean_p_ct&quot;</span>=<span class="st"> </span>mean_p_ct,
                  <span class="st">&quot;min_p_ct&quot;</span>=<span class="st"> </span>min_p_ct,
                  <span class="st">&quot;max_p_ct&quot;</span>=<span class="st"> </span>max_p_ct,
                  <span class="st">&quot;sd_p_ct&quot;</span> =<span class="st"> </span>sd_p_ct)


summary &lt;-<span class="st"> </span><span class="kw">cbind</span>(size, celltype, sim) %&gt;%<span class="st"> </span><span class="kw">set_rownames</span>(dataset_name)

### -------------- save summary object ----------------------###
<span class="kw">saveRDS</span>(summary, <span class="dt">file =</span> outputfile)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">sessionInfo</span>()</code></pre></div>
<pre><code>## R version 3.6.1 (2019-07-05)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 16.04.6 LTS
## 
## Matrix products: default
## BLAS:   /home/aluetg/R/lib/R/lib/libRblas.so
## LAPACK: /home/aluetg/R/lib/R/lib/libRlapack.so
## 
## locale:
##  [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
##  [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
##  [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
##  [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
##  [9] LC_ADDRESS=C               LC_TELEPHONE=C            
## [11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       
## 
## attached base packages:
##  [1] grid      parallel  stats4    stats     graphics  grDevices utils    
##  [8] datasets  methods   base     
## 
## other attached packages:
##  [1] readr_1.3.1                 ggrepel_0.8.2              
##  [3] CAMERA_1.42.0               xcms_3.8.2                 
##  [5] MSnbase_2.12.0              ProtGenerics_1.18.0        
##  [7] mzR_2.20.0                  Rcpp_1.0.3                 
##  [9] cowplot_1.0.0               scran_1.14.6               
## [11] gridExtra_2.3               ComplexHeatmap_2.2.0       
## [13] stringr_1.4.0               dplyr_0.8.5                
## [15] tidyr_1.0.2                 here_0.1                   
## [17] jcolors_0.0.4               purrr_0.3.3                
## [19] variancePartition_1.16.1    scales_1.1.0               
## [21] foreach_1.4.8               limma_3.42.2               
## [23] CellMixS_1.2.4              kSamples_1.2-9             
## [25] SuppDists_1.1-9.5           scater_1.14.6              
## [27] ggplot2_3.3.0               CellBench_1.2.0            
## [29] tibble_2.1.3                magrittr_1.5               
## [31] SingleCellExperiment_1.8.0  SummarizedExperiment_1.16.1
## [33] DelayedArray_0.12.2         BiocParallel_1.20.1        
## [35] matrixStats_0.55.0          Biobase_2.46.0             
## [37] GenomicRanges_1.38.0        GenomeInfoDb_1.22.0        
## [39] IRanges_2.20.2              S4Vectors_0.24.3           
## [41] BiocGenerics_0.32.0        
## 
## loaded via a namespace (and not attached):
##   [1] tidyselect_1.0.0         lme4_1.1-21              RSQLite_2.2.0           
##   [4] htmlwidgets_1.5.1        munsell_0.5.0            codetools_0.2-16        
##   [7] preprocessCore_1.48.0    statmod_1.4.34           withr_2.1.2             
##  [10] colorspace_1.4-1         knitr_1.28               rstudioapi_0.11         
##  [13] robustbase_0.93-5        mzID_1.24.0              labeling_0.3            
##  [16] GenomeInfoDbData_1.2.2   farver_2.0.3             bit64_0.9-7             
##  [19] rprojroot_1.3-2          vctrs_0.2.4              xfun_0.12               
##  [22] BiocFileCache_1.10.2     R6_2.4.1                 doParallel_1.0.15       
##  [25] ggbeeswarm_0.6.0         clue_0.3-57              rsvd_1.0.3              
##  [28] locfit_1.5-9.1           bitops_1.0-6             assertthat_0.2.1        
##  [31] nnet_7.3-13              beeswarm_0.2.3           gtable_0.3.0            
##  [34] affy_1.64.0              rlang_0.4.5              GlobalOptions_0.1.1     
##  [37] splines_3.6.1            acepack_1.4.1            impute_1.60.0           
##  [40] checkmate_2.0.0          BiocManager_1.30.10      yaml_2.2.1              
##  [43] reshape2_1.4.3           backports_1.1.5          Hmisc_4.3-1             
##  [46] MassSpecWavelet_1.52.0   RBGL_1.62.1              tools_3.6.1             
##  [49] ellipsis_0.3.0           affyio_1.56.0            gplots_3.0.3            
##  [52] RColorBrewer_1.1-2       ggridges_0.5.2           plyr_1.8.6              
##  [55] base64enc_0.1-3          progress_1.2.2           zlibbioc_1.32.0         
##  [58] RCurl_1.98-1.1           prettyunits_1.1.1        rpart_4.1-15            
##  [61] GetoptLong_0.1.8         viridis_0.5.1            cluster_2.1.0           
##  [64] colorRamps_2.3           data.table_1.12.8        circlize_0.4.8          
##  [67] RANN_2.6.1               pcaMethods_1.78.0        packrat_0.5.0           
##  [70] hms_0.5.3                evaluate_0.14            pbkrtest_0.4-8.6        
##  [73] XML_3.99-0.3             jpeg_0.1-8.1             shape_1.4.4             
##  [76] compiler_3.6.1           KernSmooth_2.23-16       ncdf4_1.17              
##  [79] crayon_1.3.4             minqa_1.2.4              htmltools_0.4.0         
##  [82] mgcv_1.8-31              Formula_1.2-3            lubridate_1.7.4         
##  [85] DBI_1.1.0                dbplyr_1.4.2             MASS_7.3-51.5           
##  [88] rappdirs_0.3.1           boot_1.3-24              Matrix_1.2-18           
##  [91] cli_2.0.2                vsn_3.54.0               gdata_2.18.0            
##  [94] igraph_1.2.4.2           pkgconfig_2.0.3          foreign_0.8-76          
##  [97] MALDIquant_1.19.3        vipor_0.4.5              dqrng_0.2.1             
## [100] multtest_2.42.0          XVector_0.26.0           digest_0.6.25           
## [103] graph_1.64.0             rmarkdown_2.1            htmlTable_1.13.3        
## [106] edgeR_3.28.1             DelayedMatrixStats_1.8.0 listarrays_0.3.1        
## [109] curl_4.3                 gtools_3.8.1             rjson_0.2.20            
## [112] nloptr_1.2.2.1           lifecycle_0.2.0          nlme_3.1-145            
## [115] BiocNeighbors_1.4.2      fansi_0.4.1              viridisLite_0.3.0       
## [118] pillar_1.4.3             lattice_0.20-40          httr_1.4.1              
## [121] DEoptimR_1.0-8           survival_3.1-11          glue_1.3.1              
## [124] png_0.1-7                iterators_1.0.12         bit_1.1-15.2            
## [127] stringi_1.4.6            blob_1.2.1               BiocSingular_1.2.2      
## [130] latticeExtra_0.6-29      caTools_1.18.0           memoise_1.1.0           
## [133] irlba_2.3.3</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
